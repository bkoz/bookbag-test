## Image Trust and Signing

#### Image signing

In this lab, you will use ```podman``` to sign container images and create trust policies to control access to registries. 

To begin the image signing procedure, a signature claim is generated by encrypting a container image manifest using a private
gpg key. The signature claims are stored in a file system or web
server where they can be decrypted later and used to pull signed
images.

![Image Encryption]({% image_path encrypt.png %})

##### Configure the signature claim store

On ```client.summit.lab```, make a backup copy of ```/etc/containers/registries.d/default.yaml ```. 

~~~shell
$ sudo cp /etc/containers/registries.d/default.yaml /etc/containers/registries.d/default.yaml.bak
~~~

Now edit ```/etc/containers/registries.d/default.yaml```.

~~~shell
$ sudo vim /etc/containers/registries.d/default.yaml
~~~

At the bottom of the file, 
create an entry for the container registry as shown below.

~~~shell
docker:
  server.summit.lab:
   sigstore: file:///usr/tmp/sigstore/server.summit.lab
   sigstore-staging: file:///usr/tmp/sigstore/server.summit.lab
~~~

Notice we are using the ```/usr/tmp``` directory to store signature
claims. This allows the system administrator to configure the signature store for a given registry and allows rootless users to push and pull signed container images.

Create a directory for the signature claims for the registry.

~~~shell
$ mkdir -p /usr/tmp/sigstore/server.summit.lab
~~~

Generate the gpg key pair. You'll be prompted to set a pass phrase.

~~~shell
$ gpg2 --quick-gen-key --yes lab-user
~~~

Now export the public key. You'll need it later.

~~~shell
$ mkdir /usr/tmp/keys
$ gpg2 --export lab-user > /usr/tmp/keys/gpg-pubkey.gpg
~~~

Confirm you have a container image with the **correct REPOSITORY and TAG** as shown. If not,
go back to lab #3 and create one.

~~~shell
$ podman images

REPOSITORY                             TAG      IMAGE ID       CREATED        SIZE
server.summit.lab/quayuser/rhel-ubi8   latest   cc7efd763847   2 months ago   216 MB
~~~

Create the signature claim. You will be prompted for the
gpg key pass phrase you used to create the key pair. The ```docker://``` registry prefix specifies the transport to use.

~~~shell
$ podman image sign --sign-by lab-user docker://server.summit.lab/quayuser/rhel-ubi8
~~~

Confirm the signature claim was created. 

~~~shell
$ ls -R /usr/tmp/sigstore/server.summit.lab/quayuser

'/usr/tmp/sigstore/server.summit.lab/quayuser/rhel-ubi8@sha256=8a5427d4c037826f4c69e268455d26327f2de158ffa1271a907fa357e9b93a3c':
signature-1
~~~

#### Pulling signed images

The procedure is reversed when pulling signed images.

![Image Decryption]({% image_path decrypt.png %})

In this exercise you will configure the image trust policy so that it allows only signed images to be pulled from a trusted registry on {{SERVER_0}}. 

Start by examining the current trust policy (which accepts anything)then create a default policy that rejects all image pulls.

~~~shell
$ podman image trust show

default             insecureAcceptAnything                         
~~~

Change the policy to reject by default.

~~~shell
$ sudo podman image trust set -t reject default

$ podman image trust show

          insecureAcceptAnything      
default   reject
~~~

Now we are ready to try an image pull. To make certain you are
authenticated to the registry, login again.

~~~shell
$ podman login --username=quayuser --password=L36PrivxRB02bqOB9jtZtWiCcMsApOGn {{SERVER_0}}

Login Succeeded!
~~~

Now test that image pulls are rejected by default.

~~~shell
$ podman pull {{SERVER_0}}/quayuser/rhel-ubi8

Trying to pull server.summit.lab/quayuser/rhel-ubi8...Failed
error pulling image "server.summit.lab/quayuser/rhel-ubi8": unable to pull server.summit.lab/quayuser/rhel-ubi8: unable to pull image: Source image rejected: Running image docker://server.summit.lab/quayuser/rhel-ubi8:latest is rejected by policy.
~~~

Set a trust policy for {{SERVER_0}} using your public gpg key.

~~~shell
$ sudo podman image trust set --type signedBy --pubkeysfile /usr/tmp/keys/gpg-pubkey.gpg server.summit.lab
~~~

Now examine the image trust again. It should show that any image
pulls from {{SERVER_0}} must be signed. 

~~~shell
$ podman image trust show

default             reject                              
server.summit.lab   signedBy                 lab-user   file:///usr/tmp/sigstore/server.summit.lab
~~~

Finally, try to pull the image from the trusted registry on {{SERVER_0}} and it should succeed.

~~~shell
$ podman pull server.summit.lab/quayuser/rhel-ubi8

Trying to pull server.summit.lab/quayuser/rhel-ubi8...Getting image source signatures
Checking if image destination supports signatures
Copying blob 4e476fa9e7b6: 71.17 MiB / ? [----------------=----------------] 3s 
Copying blob 3102a29c24c5: 1.19 KiB / ? [-----=----------------------------] 3s 
Writing manifest to image destination
Storing signatures
ba5455c663a3264b2bf21da2cd8138efa016d89d6b7af1b3c4a89431ec8f8d58
~~~

##### Extra Credit. 

In this optional exercise, you will create a trust policy that allows only signed images to be pulled from Red Hat's Container Catalog. This requires a login on ```https://registry.redhat.io```. Once you are logged in, create a **service account** and **token** to allow logins from ```podman```.

First, try a pull and it should fail based on the default policy.

~~~shell
$ podman pull docker://registry.redhat.io/ubi7/ubi-minimal

Trying to pull docker://registry.redhat.io/ubi7/ubi-minimal...ERRO[0004] Error pulling image ref //registry.redhat.io/ubi7/ubi-minimal:latest: Source image rejected: Running image docker://registry.redhat.io/ubi7/ubi-minimal:latest is rejected by policy. 
Failed
(0x564a93f84260,0xc000cb3340)
~~~

As you did above, backup and configure ```/etc/containers/registries.d/default.yaml``` by
adding a section for ```registry.redhat.io``` using Red Hat's signature store server (https://registry.redhat.io/containers/sigstore). The ```sigstore-staging``` field is not needed.

Next, add a trust policy for ```registry.redhat.io``` using Red Hat's RPM GPG key file.

~~~shell
$ sudo podman image trust set --pubkeysfile /etc/pki/rpm-gpg/RPM-GPG-KEY-redhat-release registry.redhat.io

$ podman image trust show
                             insecureAcceptAnything
default                      accept
registry.redhat.io           signedBy                 security@redhat.com, security@redhat.com   https://registry.redhat.io/containers/sigstore
~~~

Finally, using the service account and token you created for
```registry.redhat.io```, use ```podman``` to login and pull an
image.

~~~shell
$ podman login -u "1234567|user" -p "token" registry.redhat.io

Login Succeeded!
~~~

~~~shell
$ podman pull registry.redhat.io/ubi7/ubi-minimal

Trying to pull registry.redhat.io/ubi7/ubi-minimal...Getting image source signatures
Checking if image destination supports signatures
Copying blob 27402aa444ba: 30.76 MiB / 30.76 MiB [==========================] 2s
Copying blob 50495ac9ea81: 1.06 KiB / 1.06 KiB [============================] 2s
Copying config 8d0998e077d3: 4.18 KiB / 4.18 KiB [==========================] 0s
Writing manifest to image destination
Storing signatures
8d0998e077d33e40270fa89cab4d2c7a69a0a99e10593aaa81fb32924f42bb36
~~~